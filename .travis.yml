git:
  depth: 3

notifications:
  email: false

language: cpp
compiler: clang
os: linux

sudo: required
dist: trusty

addons:
  apt:
    sources:
      - llvm-toolchain-trusty-5.0
    packages:
      - clang-5.0      
      - libassimp-dev
      - libfreetype6-dev
      - libgl1-mesa-dev
      - libopenal-dev
      - libsndfile1-dev
      - libx11-dev
      - libxcb-cursor-dev
      - libxcb-ewmh-dev
      - libxcb-icccm4-dev
      - libxcb-keysyms1-dev
      - libxcb-randr0-dev
      - mesa-common-dev

env:
  global:
    - COMPILER=clang++-5.0
    - CFLAGS="-Wall -Wextra" 
    - CXXFLAGS="-Wall -Wextra"

    - ACTION=gmake
    - PLATFORM=x64
    - PLATFORMNUM=64

  matrix:
    - CONFIG=debug
      CONFIG_UPPER=Debug
      SUFFIX=-d

    - CONFIG=release
      CONFIG_UPPER=Release

branches:
  only:
  - master

deploy:
  provider: pages
  skip_cleanup: true
  github_token: ${GITHUB_TOKEN}
  target_branch: travis-${CONFIG}-${PLATFORM}
  repo: S6066/Teal-binaries
  local_dir: ${TRAVIS_BUILD_DIR}/buildresults/result/
  name: Travis CI
  on:
    branch: master

before_install:
  - export CC=clang-5.0
  - export CXX=clang++-5.0

  - cd /usr
  - sudo mkdir -p lib64

  - sudo bash -c "find / -type d -exec chmod 777 {} \;"
  - sudo bash -c "find / -type f -exec chmod 777 {} \;"

install:
  - cd ${TRAVIS_BUILD_DIR}/extlibs/include
  - mkdir nazara && cd nazara

  - curl  https://github.com/DigitalPulseSoftware/NazaraEngine/releases/download/v0.4/NazaraEngine-0.4-linux-${PLATFORM}.tar.gz -Lo nazara.tar.gz
  - tar -xzf nazara.tar.gz
  - mv package/include/Nazara Nazara && mv package/include/NDK NDK

  - cd ${TRAVIS_BUILD_DIR}/extlibs/lib/
  - mkdir -p ${ACTION} && cd ${ACTION}
  - mkdir -p ${PLATFORM} && cd ${PLATFORM}
  - mkdir -p nazara && mkdir -p micropather

  - sudo cp ${TRAVIS_BUILD_DIR}/extlibs/include/nazara/package/bin/${PLATFORM}/*.so /usr/lib
  - sudo cp ${TRAVIS_BUILD_DIR}/extlibs/include/nazara/package/bin/${PLATFORM}/*.so /usr/lib64

  - cd micropather
  - cp -r ${TRAVIS_BUILD_DIR}/extlibs/src/micropather/** ./
  - cp ${TRAVIS_BUILD_DIR}/build/premake5-linux${PLATFORMNUM} ./
  - ./premake5-linux${PLATFORMNUM} --cc=clang ${ACTION}

  - sudo make config=${CONFIG}_${PLATFORM}
  - cp bin/${PLATFORM}/${CONFIG_UPPER}/libmicropather${SUFFIX}.a ./
  - sudo cp bin/${PLATFORM}/${CONFIG_UPPER}/libmicropather${SUFFIX}.a /usr/lib

before_script:
  - cd ${TRAVIS_BUILD_DIR}/build
  - ./premake5-linux${PLATFORMNUM} --cc=clang ${ACTION}

script:
  - cd ${TRAVIS_BUILD_DIR}/build/${ACTION}
  - sudo make -j4 config=${CONFIG}_${PLATFORM}

after_success:
  - cd ${TRAVIS_BUILD_DIR}/build/${ACTION}
  - sudo mkdir result
  - sudo cp ${CONFIG_UPPER}/${PLATFORM}/TealDemo ./result/TealDemo

  - cd result
  - sudo cp ${TRAVIS_BUILD_DIR}/extlibs/include/nazara/package/bin/${PLATFORM}/NazaraAudio${SUFFIX}.so ./
  - sudo cp ${TRAVIS_BUILD_DIR}/extlibs/include/nazara/package/bin/${PLATFORM}/NazaraCore${SUFFIX}.so ./
  - sudo cp ${TRAVIS_BUILD_DIR}/extlibs/include/nazara/package/bin/${PLATFORM}/NazaraGraphics${SUFFIX}.so ./
  - sudo cp ${TRAVIS_BUILD_DIR}/extlibs/include/nazara/package/bin/${PLATFORM}/NazaraLua${SUFFIX}.so ./
  - sudo cp ${TRAVIS_BUILD_DIR}/extlibs/include/nazara/package/bin/${PLATFORM}/NazaraNetwork${SUFFIX}.so ./
  - sudo cp ${TRAVIS_BUILD_DIR}/extlibs/include/nazara/package/bin/${PLATFORM}/NazaraNoise${SUFFIX}.so ./
  - sudo cp ${TRAVIS_BUILD_DIR}/extlibs/include/nazara/package/bin/${PLATFORM}/NazaraPhysics2D${SUFFIX}.so ./
  - sudo cp ${TRAVIS_BUILD_DIR}/extlibs/include/nazara/package/bin/${PLATFORM}/NazaraPhysics3D${SUFFIX}.so ./
  - sudo cp ${TRAVIS_BUILD_DIR}/extlibs/include/nazara/package/bin/${PLATFORM}/NazaraRenderer${SUFFIX}.so ./
  - sudo cp ${TRAVIS_BUILD_DIR}/extlibs/include/nazara/package/bin/${PLATFORM}/NazaraSDK${SUFFIX}.so ./
  - sudo cp ${TRAVIS_BUILD_DIR}/extlibs/include/nazara/package/bin/${PLATFORM}/NazaraSDKServer${SUFFIX}.so ./
  - sudo cp ${TRAVIS_BUILD_DIR}/extlibs/include/nazara/package/bin/${PLATFORM}/NazaraUtility${SUFFIX}.so ./
  - sudo cp ${TRAVIS_BUILD_DIR}/extlibs/include/nazara/package/bin/${PLATFORM}/NazaraPlatform${SUFFIX}.so ./
  - sudo cp -r ${TRAVIS_BUILD_DIR}/wdirs/data ./

  - cd ${TRAVIS_BUILD_DIR}
  - mkdir buildresults
  - cd buildresults
  - cp -r ${TRAVIS_BUILD_DIR}/build/${ACTION}/result/* ./

  - tar -zcvf tealdemo.tar.gz *
  - mkdir result
  - mv tealdemo.tar.gz result

  - cd result
  - touch commit-info
  - printf "Travis CI Build ${TRAVIS_JOB_NUMBER} (${CONFIG} ${PLATFORM})\nCommit hash - ${TRAVIS_COMMIT}\n\nCommit message:\n${TRAVIS_COMMIT_MESSAGE}" > commit-info
